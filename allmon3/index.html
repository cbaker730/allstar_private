<!DOCTYPE html>
<!--
#
# Copyright(C) 2023-2025 AllStarLink
# Allmon3 and all components are Licensed under the AGPLv3
# see https://raw.githubusercontent.com/AllStarLink/Allmon3/develop/LICENSE
# Bootstrap libraries are licensed separately
# SVG icons inline are from FontAwesome licensed under CC-BY-4.0
# create commons with attribution
#
-->
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="AllStarLink">
    <title>Allmon3</title>
    <!-- CSS -->
    <link href="css/bootstrap.min.css?v=1.7.0" rel="stylesheet" crossorigin="anonymous">
    <link href="css/main.css?v=1.7.0" rel="stylesheet">
    <link href="css/custom.css?v=1.7.0" rel="stylesheet">
    <!-- Favicons -->
    <link rel="apple-touch-icon" href="img/favicons/favicon-180x180.png" type="image/png" sizes="180x180">
    <link rel="icon" href="img/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="img/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="img/favicons/favicon.ico" type="image/png">
</head>
<body>
<!-- SVG Symbols – FULL SET RESTORED -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
    <symbol id="settings" fill="currentColor" viewBox="0 0 16 16">
        <path d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.613.931l-.08.284a.96.96 0 0 0 1.187 1.187l.283-.081c.96-.275 1.65.918.931 1.613l-.211.205a.96.96 0 0 0 .434 1.622l.286.071c.97.243.97 1.62 0 1.864l-.286.071a.96.96 0 0 0-.434 1.622l.211.205c.719.695.03 1.888-.931 1.613l-.284-.08a.96.96 0 0 0-1.187 1.187l.081.283c.275.96-.918 1.65-1.613.931l-.205-.211a.96.96 0 0 0-1.622.434l-.071.286c-.243.97-1.62.97-1.864 0l-.071-.286a.96.96 0 0 0-1.622-.434l-.205.211c-.695.719-1.888.03-1.613-.931l.08-.284a.96.96 0 0 0-1.186-1.187l-.284.081c-.96.275-1.65-.918-.931-1.613l.211-.205a.96.96 0 0 0-.434-1.622l-.286-.071c-.97-.243-.97-1.62 0-1.864l.286-.071a.96.96 0 0 0 .434-1.622l-.211-.205c-.719-.695-.03-1.888.931-1.613l.284.08a.96.96 0 0 0 1.187-1.186l-.081-.284c-.275-.96.918-1.65 1.613-.931l.205.211a.96.96 0 0 0 1.622-.434l.071-.286zM12.973 8.5H8.25l-2.834 3.779A4.998 4.998 0 0 0 12.973 8.5zm0-1a4.998 4.998 0 0 0-7.557-3.779l2.834 3.78h4.723zM5.048 3.967c-.03.021-.058.043-.087.065l.087-.065zm-.431.355A4.984 4.984 0 0 0 3.002 8c0 1.455.622 2.765 1.615 3.678L7.375 8 4.617 4.322zm.344 7.646.087.065-.087-.065z"/>
    </symbol>
    <!-- ... (all other symbols unchanged) ... -->
</svg>

<header class="navbar navbar-dark sticky-top flex-md-nowrap p-0">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="index.html">
        <img id="header-banner-img" class="header-banner-img" src="img/asl-banner-logo.png" alt="asl-logo">
    </a>
    <button id="collapse-navbar-button" class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navbar-midbar" class="navbar-midbar d-none d-sm-block"></div>
    <div id="navbar-right" class="navbar-right"></div>
</header>

<!-- Login / Logout / Command Modals unchanged -->
<!-- ... (keep all your modal code exactly as it was) ... -->

<div class="container-fluid">
    <div class="row">
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <!-- sidebar content unchanged -->
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div id="asl-statmon-dashboard-area"></div>

            <!-- Added: Header for Announcement Manager – shown only after login -->
            <div id="announcements-header" style="display:none; margin: 40px 0 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                <h3 style="margin: 0 0 8px 0;">Announcement Manager</h3>
                <p style="margin: 0; color: #555;">
                    Schedule announcements • Choose <strong>local</strong> (this node) or <strong>global</strong> (all linked nodes)
                </p>
            </div>

            <!-- Announcements Manager content will be loaded here -->
        </main>

        <footer class="col-md-9 ms-sm-auto col-lg-10 px-md-4 my-2 mx-3">
            <hr>
            <p>Copyright &copy; 2023-2025 AllStarLink<br>
            Allmon3 is distributed under the terms of the <a href="https://raw.githubusercontent.com/AllStarLink/Allmon3/develop/LICENSE">AGPLv3</a></p>
        </footer>
    </div>
</div>

<!-- Scripts (unchanged order) -->
<script src="js/bootstrap.bundle.min.js?v=1.7.0" crossorigin="anonymous"></script>
<script src="js/functions.js?v=1.7.0" crossorigin="anonymous"></script>
<script src="js/commands.js?v=1.7.0" crossorigin="anonymous"></script>
<script src="js/index.js?v=1.7.0" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Updated Announcement Manager loader -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Announce] Page loaded - starting');
    let container = null;
    let isLoggedIn = false;
    let pollInterval = null;

    function createContainer() {
        if (container) return container;
        container = document.createElement('div');
        container.id = 'announcements-container';
        container.style.marginTop = '20px';
        let dashboard = document.getElementById('asl-statmon-dashboard-area');
        if (!dashboard) {
            dashboard = document.querySelector('main') || document.body;
        }
        dashboard.appendChild(container);
        console.log('[Announce] Container created');
        return container;
    }

    function loadAnnouncements() {
        if (!isLoggedIn) return;
        console.log('[Announce] Loading manager');

        // Show header
        const header = document.getElementById('announcements-header');
        if (header) header.style.display = 'block';

        const cont = createContainer();
        if (!cont) return;

        cont.innerHTML = '<div class="alert alert-info">Loading Announcements Manager...</div>';

        fetch('custom/announcement.inc', { cache: 'no-cache' })
            .then(response => {
                if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
                return response.text();
            })
            .then(html => {
                let cleaned = html
                    .replace(/<\?php\s*if\s*\([^)]*\)\s*\{[\s\S]*?\}\s*\?>/gs, '')
                    .replace(/<\?php[\s\S]*?\?>/gs, '')
                    .trim();
                cont.innerHTML = cleaned;

                const scripts = cont.getElementsByTagName('script');
                Array.from(scripts).forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

                console.log('[Announce] Loaded successfully');
            })
            .catch(err => {
                console.error('[Announce] Load error:', err);
                cont.innerHTML = `<div class="alert alert-danger">Failed: ${err.message}</div>`;
            });
    }

    function removeAnnouncements() {
        if (container) {
            container.remove();
            container = null;
            console.log('[Announce] Removed (logout detected)');
        }
        // Hide header on logout
        const header = document.getElementById('announcements-header');
        if (header) header.style.display = 'none';
    }

    // Reliable login/logout detection (your original logic kept)
    function updateLoginState() {
        const hasLogout = !!document.querySelector('#login-out-region [onclick*="doLogout"], #login-out-region [data-bs-target="#logoutModal"], .btn-logout');
        const loginModalOpen = document.getElementById('loginModal')?.classList.contains('show');
        const dashboardVisible = document.getElementById('asl-statmon-dashboard-area')?.offsetParent !== null;
        const nowLoggedIn = hasLogout && !loginModalOpen && dashboardVisible;

        if (nowLoggedIn !== isLoggedIn) {
            isLoggedIn = nowLoggedIn;
            if (isLoggedIn) {
                loadAnnouncements();
            } else {
                removeAnnouncements();
            }
        }
    }

    // Hook doLogin / doLogout
    const originalDoLogin = window.doLogin || function(){};
    window.doLogin = function(...args) {
        const result = originalDoLogin.apply(this, args);
        isLoggedIn = true;
        loadAnnouncements();
        return result;
    };

    const originalDoLogout = window.doLogout || function(){};
    window.doLogout = function(...args) {
        originalDoLogout.apply(this, args);
        isLoggedIn = false;
        removeAnnouncements();
    };

    pollInterval = setInterval(updateLoginState, 2000);
    updateLoginState();

    window.addEventListener('beforeunload', () => {
        if (pollInterval) clearInterval(pollInterval);
    });
});
</script>
</body>
</html>
